plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android' version '2.0.21'
    id 'org.jetbrains.kotlin.plugin.serialization' version '2.0.21'
    id 'org.jetbrains.kotlin.plugin.compose' version '2.0.21'
}

android {
    namespace 'com.whispercppdemo'
    compileSdk 35

    defaultConfig {
        applicationId "com.whispercppdemo"
        minSdk 26
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"

        // VectorDrawable ã‚’ã‚µãƒãƒ¼ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµŒç”±ã§ä½¿ã†è¨­å®š
        vectorDrawables {
            useSupportLibrary true
        }
    }

    buildTypes {
        release {
            signingConfig signingConfigs.debug
            minifyEnabled true
            // æ¨™æº–ã®æœ€é©åŒ–ãƒ«ãƒ¼ãƒ«ã¨ãƒ—ãƒ­ã‚¬ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    // Java / Kotlin ä¸¡å¯¾å¿œã®äº’æ›æ€§
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    kotlinOptions {
        jvmTarget = '17'
    }

    buildFeatures {
        compose true
    }

    // Kotlin 2.0+ ã‹ã¤ org.jetbrains.kotlin.plugin.compose ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ãã¯
    // æ‰‹å‹•ã§ kotlinCompilerExtensionVersion ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ã¯åŸºæœ¬çš„ã«ãªã„ï¼ˆè¡çªã‚’é¿ã‘ã‚‹ï¼‰ã€‚
    // composeOptions {
    //     kotlinCompilerExtensionVersion = '1.5.3'
    // }
}

dependencies {
    // ãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¸ã®ä¾å­˜ï¼ˆWhisper core ãªã©ï¼‰
    implementation project(':nativelib')

    // Compose ã® BOM ã‚’ä½¿ã£ã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’çµ±ä¸€
    implementation platform(libs.androidx.compose.bom)

    // Compose / UI é–¢é€£ï¼ˆBOM ãŒã‚ã‚‹ã®ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯çœç•¥ï¼‰
    implementation libs.androidx.activity.compose
    implementation libs.androidx.ui                  // alias for compose UI
    implementation libs.androidx.ui.tooling.preview  // preview tooling
    implementation libs.androidx.material3           // Material3
    implementation libs.androidx.material.icons.extended // ã‚¢ã‚¤ã‚³ãƒ³æ‹¡å¼µï¼ˆä¾‹: Icons.Filled.Micï¼‰

    // AndroidX åŸºç›¤ï¼ˆCoreComponentFactory å¯¾ç­–å«ã‚€ï¼‰
    implementation libs.androidx.core.ktx.v1160
    implementation libs.androidx.appcompat.v171

    // ViewModel + Compose çµ±åˆ
    implementation libs.androidx.lifecycle.viewmodel.compose

    // æ¨©é™ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆAccompanistï¼‰
    implementation libs.accompanist.permissions

    // Kotlin ã‚³ãƒ«ãƒ¼ãƒãƒ³ & ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³
    implementation libs.kotlinx.coroutines.core
    implementation libs.kotlinx.serialization.json

    // ãƒ†ã‚¹ãƒˆå‘¨ã‚Šï¼ˆå¿…è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚’å¤–ã—ã¦ä½¿ã†ï¼‰
    // testImplementation 'junit:junit:4.13.2'
    // androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    // androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
    // androidTestImplementation "androidx.compose.ui:ui-test-junit4:1.5.0"
    // debugImplementation "androidx.compose.ui:ui-tooling:1.5.0"
    // debugImplementation "androidx.compose.ui:ui-test-manifest:1.5.0"
}

// ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆä¾‹: whisper_coreï¼‰ãŒå­˜åœ¨ã—ãªã„ã‹ç©ºã®å ´åˆã€å†å¸°çš„ã«åˆæœŸåŒ– & æ›´æ–°ã™ã‚‹ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯
tasks.register("checkSubmodule") {
    description = "Ensure the git submodule 'nativelib/whisper_core' is initialized and populated."
    group = "setup"

    doLast {
        def submoduleDir = file("nativelib/whisper_core")

        // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ä¸­èº«ãŒç©ºãªã‚‰åˆæœŸåŒ–
        def isMissingOrEmpty = !submoduleDir.exists() || (submoduleDir.listFiles()?.length ?: 0) == 0
        if (isMissingOrEmpty) {
            println "ğŸ”„ Submodule '${submoduleDir}' is missing or empty. Initializing/updating recursively..."
            exec {
                commandLine("git", "submodule", "update", "--init", "--recursive")
            }
        } else {
            println "âœ… Submodule '${submoduleDir}' already initialized and populated."
        }
    }
}

// ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚¿ã‚¹ã‚¯ï¼ˆå­˜åœ¨ã—ãªã‘ã‚Œã°å–å¾—ï¼‰
tasks.register("downloadModel", Exec) {
    description = "Download required ggml/Whisper models via the helper script."
    group = "setup"
    commandLine "/bin/bash", "./download_models.sh"
}

// ãƒ“ãƒ«ãƒ‰å‰ã«å¿…é ˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
preBuild.dependsOn tasks.named("checkSubmodule")
preBuild.dependsOn tasks.named("downloadModel")
